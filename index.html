<!DOCTYPE html>
<html lang="vi">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0, user-scalable=no">
<title>QR Check-in</title>

<script src="https://unpkg.com/html5-qrcode"></script>

<style>
body { margin:0; font-family:Arial; background:#111; color:#fff; text-align:center }
#reader { width:320px; margin:auto; display:none }
#counter { font-size:64px; margin:10px }
#status { font-size:22px; margin:10px }
input, button { font-size:22px; padding:10px; margin:8px }
.ok { background:#1b5e20 }
.bad { background:#b71c1c }
.neutral { background:#111 }
</style>
</head>

<body class="neutral">

<h2>CHECK-IN QR</h2>

<div id="setup">
  <p>Nhập mã máy (vd: may02)</p>
  <input id="machineInput" placeholder="may02">
  <br>
  <button onclick="saveMachine()">XÁC NHẬN</button>
</div>

<div id="main" style="display:none">
  <div id="counter">0</div>
  <div id="status">Sẵn sàng quét</div>
  <div id="reader"></div>
  <button onclick="startScan()">BẮT ĐẦU</button>
</div>

<script>
const VALID_KEY = "DTD-15NAM";
const SCRIPT_URL = "https://script.google.com/macros/s/AKfycbzg72_sQfbQLVTyoXYtC374UwFC2DSdKZ7t77rUWG8-MraKZLjtxU3Ap8nMyeB2tPosKw/exec"; // <<< DÁN URL APPS SCRIPT

let machine = localStorage.getItem("machine");
let count = Number(localStorage.getItem("count") || 0);
let scanned = false;
let qr;

if (machine) initMain();

function saveMachine() {
  const v = document.getElementById("machineInput").value.trim();
  if (!v) return alert("Nhập mã máy");
  machine = v;
  localStorage.setItem("machine", machine);
  initMain();
}

function initMain() {
  document.getElementById("setup").style.display = "none";
  document.getElementById("main").style.display = "block";
  document.getElementById("counter").innerText = count;
}

function startScan() {
  document.getElementById("reader").style.display = "block";
  qr = new Html5Qrcode("reader");

  Html5Qrcode.getCameras().then(devices => {
    const camId = devices[devices.length - 1].id;
    qr.start(
      camId,
      { fps:10, qrbox:250 },
      txt => {
        if (scanned) return;
        scanned = true;

        if (txt.trim() === VALID_KEY) {
          count++;
          localStorage.setItem("count", count);
          document.body.className = "ok";
          document.getElementById("counter").innerText = count;
          document.getElementById("status").innerText = "HỢP LỆ";
        } else {
          document.body.className = "bad";
          document.getElementById("status").innerText = "SAI QR";
        }

        setTimeout(() => {
          document.body.className = "neutral";
          document.getElementById("status").innerText = "Đưa QR vào khung";
          scanned = false;
        }, 1200);
      }
    );
  });
}

/* GỬI DỮ LIỆU LÊN GOOGLE SHEET MỖI 10 GIÂY */
setInterval(() => {
  if (!machine) return;

  fetch(SCRIPT_URL, {
    method: "POST",
    body: JSON.stringify({
      may: machine,
      count: count
    })
  }).catch(() => {});
}, 60000);
</script>

</body>
</html>
